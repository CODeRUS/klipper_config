# This file contains a configuration for the "Anycubic Kossel Linear
# Plus Large Printing Size", "Anycubic Kossel Pulley Plus Large
# Printing Size" and similar delta printer from 2017.
# The Anycubic delta printers use the TriGorilla board which is an
# AVR ATmega2560 Arduino + RAMPS compatible board.
# To use this config, the firmware should be compiled for the AVR atmega2560.

# See docs/Config_Reference.md for a description of parameters.

[printer]
kinematics: delta
max_velocity: 150
max_accel: 5000
max_accel_to_decel: 5000
max_z_velocity: 50
square_corner_velocity: 5
delta_radius: 134.67
# delta_radius: 136.988778
print_radius: 120
# if you want to DELTA_CALIBRATE you may need that
minimum_z_position: -5

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_5D0032000551393038383735-if00
restart_method: command
# serial: socket://192.168.1.34:23
# serial: /home/pi/klipper/port
# baud: 250000

[include pins.cfg]
[include kiauh_macros.cfg]
[include axes.cfg]
[include tmc.cfg]
[include extruder.cfg]
[include heater_bed.cfg]

[pause_resume]
recover_velocity: 150

[display_status]
[respond]
[gcode_arcs]

[virtual_sdcard]
path: ~/gcode_files

[output_pin RST]
pin: PC5
value: 1
shutdown_value: 1

[gcode_macro RESET]
gcode:
  SET_PIN PIN=RST VALUE=0
  RESTART

[fan]
pin: FAN_NOZZLE
kick_start_time: 0.200

[heater_fan extruder_cooler_fan]
pin: FAN_EXTRUDER
heater: extruder
heater_temp: 50
fan_speed: 1

[endstop_phase]

# if you want to use your probe for DELTA_CALIBRATE you will need that
[probe]
pin: ^AXE_Z_MIN
z_offset: 15.50
samples: 3
speed: 1
lift_speed: 10
sample_retract_dist: 1
samples_tolerance: 0.02
samples_tolerance_retries: 20

[bed_mesh]
speed: 80
horizontal_move_z: 18
mesh_radius: 110
mesh_origin: 0,0
round_probe_count: 5

[delta_calibrate]
radius: 115
speed: 30
horizontal_move_z: 19

[idle_timeout]
gcode:
    M84
    TURN_OFF_HEATERS
timeout: 1200

[force_move]
enable_force_move: True

[temperature_fan rumba]
pin: FAN_MCU
sensor_type: temperature_mcu
min_temp: 20
max_temp: 90
target_temp: 35
max_delta: 2.0
control: watermark

[filament_switch_sensor filament_runout]
switch_pin: ^AXE_X_MIN
pause_on_runout: False
runout_gcode:
  {% if printer.idle_timeout.state|lower == "printing" and printer.pause_resume.is_paused|lower == 'false' %}
  RESPOND PREFIX=tgalarm MSG="Filament runout"
  PAUSE
  {% else %}
  RESPOND PREFIX=tgnotify MSG="Filament removed"
  {% endif %}
insert_gcode:
  RESPOND PREFIX=tgnotify MSG="Filament inserted"

[gcode_macro FILAMENT_CHANGE]
gcode:
  RESPOND PREFIX=tgalarm MSG="Filament change. Print paused!"
  PAUSE

[gcode_macro FILAMENT_UNLOAD]
gcode:
  G1 E-100 F250

[gcode_macro FILAMENT_LOAD]
gcode:
  G91
  G1 E70 F250
  G1 E30 F120
  G4 P3000
  {% set E = printer["gcode_macro PAUSE"].extrude|float %}
  G1 E-{E} F2100

[gcode_macro FILAMENT_LOAD_RESUME]
gcode:
  FILAMENT_LOAD
  RESUME

[gcode_macro G4]
rename_existing: G4.1
gcode:
  {% if 'S' in params %}
    G4.1 P{ params.S|int * 1000 }
  {% elif 'P' in params %}
    G4.1 P{ params.P|int }
  {% endif %}

[gcode_macro T0]
gcode:
  RESPOND MSG="Color 1"
  
[gcode_macro T1]
gcode:
  RESPOND MSG="Color 2"
  
[gcode_macro T2]
gcode:
  RESPOND MSG="Color 3"
  
[gcode_macro T3]
gcode:
  RESPOND MSG="Color 4"
  
[gcode_macro T4]
gcode:
  RESPOND MSG="Color 5"
  
[gcode_macro T5]
gcode:
  RESPOND MSG="Color 6"
  
[gcode_macro T6]
gcode:
  RESPOND MSG="Color 7"
  
[gcode_macro T7]
gcode:
  RESPOND MSG="Color 8"
  
[gcode_macro T8]
gcode:
  RESPOND MSG="Color 9"
  
[gcode_macro T9]
gcode:
  RESPOND MSG="Color 10"

[gcode_macro QUERY_STATE]
gcode:
  RESPOND MSG={printer.idle_timeout.state|lower}

[gcode_macro QUERY_PAUSE]
gcode:
  RESPOND MSG={printer.pause_resume.is_paused|lower}

[adxl345]
# cs_pin: PA2
# spi_bus: spi1
cs_pin: PD12
spi_software_sclk_pin: PA9
spi_software_mosi_pin: PD13
spi_software_miso_pin: PA10

[resonance_tester]
accel_chip: adxl345
accel_per_hz: 50
probe_points: 0,0,40

[firmware_retraction]
retract_length: 0.3
retract_speed: 25
unretract_speed: 25

# "RepRapDiscount 2004 Smart Controller" type displays
[display]
lcd_type: hd44780
rs_pin: PE10
e_pin: PE9
d4_pin: PE12
d5_pin: PE13
d6_pin: PE14
d7_pin: PE15
encoder_pins: ^PB2, ^PB1
click_pin: ^!PE7
#kill_pin: ^<RST>

[include display_custom.cfg]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 30.213
#*# pid_ki = 1.815
#*# pid_kd = 125.763
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 57.565
#*# pid_ki = 2.326
#*# pid_kd = 356.181
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 35.0
#*# shaper_type_y = ei
#*# shaper_freq_y = 34.6
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.397349, -0.397349, -0.397349, -0.397349, -0.397349
#*# 	  -0.076182, -0.076182, -0.075423, 0.027985, 0.027985
#*# 	  0.244037, -0.016981, -0.000000, -0.004481, 0.144037
#*# 	  -0.169603, -0.169603, -0.152671, -0.169603, -0.169603
#*# 	  0.033702, 0.033702, 0.033702, 0.033702, 0.033702
#*# tension = 0.2
#*# min_x = -110.0
#*# algo = lagrange
#*# y_count = 5
#*# mesh_y_pps = 2
#*# min_y = -110.0
#*# x_count = 5
#*# max_y = 109.99
#*# mesh_x_pps = 2
#*# max_x = 110.0
