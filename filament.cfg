[gcode_macro SET_FILAMENT]
gcode:
  {% set nozzle_diameter = params.NOZZLE|default(0.4)|float %}
  {% set filament_type = params.TYPE|default("PETG_SOVETOV") %}
  RESET_VELOCITY
  M118 SET_FILAMENT_{filament_type}
  {% if "gcode_macro SET_FILAMENT_" + filament_type in printer %}
  SET_FILAMENT_{filament_type} NOZZLE={nozzle_diameter}
  {% else %}
  M118 Warning! Filament settings missing for {filament_type}. Loading default ones.
  SET_FILAMENT_PETG_SOVETOV NOZZLE={nozzle_diameter}
  {% endif %}

[gcode_macro SET_FILAMENT_PLA_CHINA]
gcode:
  SET_PRESSURE_ADVANCE ADVANCE=0.017 SMOOTH_TIME=0.01
  SET_RETRACTION RETRACT_LENGTH=0.7 RETRACT_SPEED=30 UNRETRACT_SPEED=30

[gcode_macro SET_FILAMENT_PLA_U3]
gcode:
  SET_PRESSURE_ADVANCE ADVANCE=0.017 SMOOTH_TIME=0.01
  SET_RETRACTION RETRACT_LENGTH=0.3 RETRACT_SPEED=30 UNRETRACT_SPEED=30

[gcode_macro SET_FILAMENT_ABS_SOVETOV]
gcode:
  SET_PRESSURE_ADVANCE ADVANCE=0.022 SMOOTH_TIME=0.01
  SET_RETRACTION RETRACT_LENGTH=0.4 RETRACT_SPEED=30 UNRETRACT_SPEED=30

[gcode_macro SET_FILAMENT_ABS_HTP]
gcode:
  SET_PRESSURE_ADVANCE ADVANCE=0.017 SMOOTH_TIME=0.01
  SET_RETRACTION RETRACT_LENGTH=0.4 RETRACT_SPEED=30 UNRETRACT_SPEED=30

[gcode_macro SET_FILAMENT_TPU_SOVETOV]
gcode:
  SET_PRESSURE_ADVANCE ADVANCE=0.0 SMOOTH_TIME=0.01
  SET_RETRACTION RETRACT_LENGTH=1.5 RETRACT_SPEED=30 UNRETRACT_SPEED=30

[gcode_macro SET_FILAMENT_PLA_SOVETOV]
gcode:
  {% set nozzle_diameter = params.NOZZLE|default(0.4)|float %}
  {% if nozzle_diameter == 1.2 %}
  SET_PRESSURE_ADVANCE ADVANCE=0.002 SMOOTH_TIME=0.01
  SET_RETRACTION RETRACT_LENGTH=1.5 RETRACT_SPEED=30 UNRETRACT_SPEED=30
  {% elif nozzle_diameter == 1.0 %}
  SET_PRESSURE_ADVANCE ADVANCE=0.005 SMOOTH_TIME=0.01
  SET_RETRACTION RETRACT_LENGTH=1.5 RETRACT_SPEED=30 UNRETRACT_SPEED=30
  {% elif nozzle_diameter == 0.8 %}
  SET_PRESSURE_ADVANCE ADVANCE=0.015 SMOOTH_TIME=0.01
  SET_RETRACTION RETRACT_LENGTH=0.8 RETRACT_SPEED=30 UNRETRACT_SPEED=30
  {% elif nozzle_diameter == 0.6 %}
  SET_PRESSURE_ADVANCE ADVANCE=0.025 SMOOTH_TIME=0.01
  SET_RETRACTION RETRACT_LENGTH=0.5 RETRACT_SPEED=30 UNRETRACT_SPEED=30
  {% elif nozzle_diameter == 0.4 %}
  SET_PRESSURE_ADVANCE ADVANCE=0.021 SMOOTH_TIME=0.01
  SET_RETRACTION RETRACT_LENGTH=0.6 RETRACT_SPEED=30 UNRETRACT_SPEED=30
  {% elif nozzle_diameter == 0.2 %}
  SET_PRESSURE_ADVANCE ADVANCE=0.12 SMOOTH_TIME=0.03
  SET_RETRACTION RETRACT_LENGTH=0.6 RETRACT_SPEED=30 UNRETRACT_SPEED=30
  {% endif %}

[gcode_macro SET_FILAMENT_PETG_SOVETOV]
gcode:
  {% set nozzle_diameter = params.NOZZLE|default(0.4)|float %}
  {% if nozzle_diameter == 1.2 %}
  SET_PRESSURE_ADVANCE ADVANCE=0.002 SMOOTH_TIME=0.01
  SET_RETRACTION RETRACT_LENGTH=1.5 RETRACT_SPEED=30 UNRETRACT_SPEED=30
  {% elif nozzle_diameter == 1.0 %}
  SET_PRESSURE_ADVANCE ADVANCE=0.005 SMOOTH_TIME=0.01
  SET_RETRACTION RETRACT_LENGTH=1.5 RETRACT_SPEED=30 UNRETRACT_SPEED=30
  {% elif nozzle_diameter == 0.8 %}
  SET_PRESSURE_ADVANCE ADVANCE=0.015 SMOOTH_TIME=0.01
  SET_RETRACTION RETRACT_LENGTH=0.8 RETRACT_SPEED=30 UNRETRACT_SPEED=30
  {% elif nozzle_diameter == 0.6 %}
  SET_PRESSURE_ADVANCE ADVANCE=0.025 SMOOTH_TIME=0.01
  SET_RETRACTION RETRACT_LENGTH=0.5 RETRACT_SPEED=30 UNRETRACT_SPEED=30
  {% elif nozzle_diameter == 0.4 %}
  SET_PRESSURE_ADVANCE ADVANCE=0.021 SMOOTH_TIME=0.01
  SET_RETRACTION RETRACT_LENGTH=0.6 RETRACT_SPEED=30 UNRETRACT_SPEED=30
  {% elif nozzle_diameter == 0.2 %}
  SET_PRESSURE_ADVANCE ADVANCE=0.12 SMOOTH_TIME=0.03
  SET_RETRACTION RETRACT_LENGTH=0.6 RETRACT_SPEED=30 UNRETRACT_SPEED=30
  {% endif %}

[gcode_macro SET_FILAMENT_PA_STROY]
gcode:
  {% set nozzle_diameter = params.NOZZLE|default(0.4)|float %}
  SET_PRESSURE_ADVANCE ADVANCE=0.03 SMOOTH_TIME=0.01
  SET_RETRACTION RETRACT_LENGTH=0.5 RETRACT_SPEED=30 UNRETRACT_SPEED=30

[gcode_macro RESET_VELOCITY]
gcode:
  {% set config_accel = printer.configfile.config.printer.max_accel|int %}
  {% set config_decel = printer.configfile.config.printer.max_accel_to_decel|int %}
  {% set config_velocity = printer.configfile.config.printer.max_velocity|int %}
  SET_VELOCITY_LIMIT ACCEL={config_accel} ACCEL_TO_DECEL={config_decel} VELOCITY={config_velocity}