[include kiauh_macros.cfg]

[include pins.cfg]
[include axes.cfg]
[include extruder.cfg]
[include probe.cfg]
[include resonance.cfg]
[include heater_bed.cfg]
[include tmc.cfg]
[include timelapse.cfg]
[include exclude_object.cfg]
[include filament.cfg]
[include print_macro.cfg]
[include debug_macro.cfg]

[pause_resume]

[display_status]

[virtual_sdcard]
path: ~/gcode_files

[respond]

[gcode_macro PRINT_VARS]
gcode:
  {% set i = printer.idle_timeout[params.S] %}
  {action_respond_info(i)}

[mcu]
#serial: /dev/serial0
#baud: 250000
restart_method: command
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_12345-if00

[printer]
kinematics: cartesian
max_velocity: 150
max_accel: 2000
max_accel_to_decel: 1500
max_z_velocity: 25
max_z_accel: 500
square_corner_velocity: 5

[force_move]
enable_force_move: True

[output_pin RST]
pin: PC5
value: 1
shutdown_value: 1

[gcode_macro RESET]
gcode:
  SET_PIN PIN=RST VALUE=0
  RESTART

[fan]
pin: FAN_NOZZLE

[heater_fan extruder]
pin: FAN_EXTRUDER
heater: extruder
heater_temp: 50.0
fan_speed: 1.0

[temperature_fan rumba]
pin: FAN_MCU
sensor_type: temperature_mcu
min_temp: 20
max_temp: 90
target_temp: 35
max_delta: 2.0
control: watermark

[endstop_phase]

[idle_timeout]
gcode:
    M84 X Y Z E
    TURN_OFF_HEATERS
timeout: 1200

[filament_switch_sensor filament_runout]
switch_pin: ^AXE_X_MAX
pause_on_runout: False
runout_gcode:
  {% if printer.idle_timeout.state|lower == "printing" and printer.pause_resume.is_paused|lower == 'false' %}
  RESPOND PREFIX=tgalarm MSG="Filament runout"
  PAUSE
  {% else %}
  RESPOND PREFIX=tgnotify MSG="Filament removed"
  {% endif %}
insert_gcode:
  RESPOND PREFIX=tgnotify MSG="Filament inserted"

[gcode_macro QUERY_STATE]
gcode:
  RESPOND MSG={printer.idle_timeout.state|lower}

[gcode_macro QUERY_PAUSE]
gcode:
  RESPOND MSG={printer.pause_resume.is_paused|lower}

[gcode_macro FILAMENT_UNLOAD]
gcode:
  G1 E-50 F250

[gcode_macro FILAMENT_LOAD]
gcode:
  G91
  G1 E70 F250
  G4 P3000
  ##### read E from pause macro #####
  {% set e = printer["gcode_macro PAUSE"].extrude|float %}
  G1 E-{e} F2100

[gcode_macro G4]
rename_existing: G4.1
gcode:
  {% if 'S' in params %}
    G4.1 P{ params.S|int * 1000 }
  {% elif 'P' in params %}
    G4.1 P{ params.P|int }
  {% endif %}

[gcode_macro RESET_AXES]
gcode:
  SAVE_GCODE_STATE NAME=RESET_AXES
  {% set z = printer.toolhead.position.z|float %}
  SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=0
  SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=0
  SET_KINEMATIC_POSITION Z={z}
  G28 X Y
  RESTORE_GCODE_STATE NAME=RESET_AXES MOVE=1

[firmware_retraction]
retract_length: 0.3
retract_speed: 20
unretract_speed: 25

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 24.157
#*# pid_ki = 1.789
#*# pid_kd = 81.529
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 49.634
#*# pid_ki = 1.408
#*# pid_kd = 437.399
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -2.166577, -2.154754, -2.103868, -2.121420, -2.150223, -2.159337, -2.165014
#*# 	  -2.122723, -2.127045, -2.094598, -2.093920, -2.102983, -2.177045, -2.188973
#*# 	  -2.150170, -2.130795, -2.080535, -2.056212, -2.044077, -2.084181, -2.071473
#*# 	  -2.049337, -2.069285, -2.046993, -2.057462, -2.061993, -2.150743, -2.177358
#*# 	  -2.093191, -2.103452, -2.073660, -2.097931, -2.129545, -2.161004, -2.156993
#*# 	  -2.035483, -2.056785, -2.044233, -2.051681, -2.135275, -2.178868, -2.256837
#*# 	  -2.122723, -2.137045, -2.118348, -2.188295, -2.238816, -2.289598, -2.329754
#*# tension = 0.2
#*# min_x = 4.0
#*# algo = bicubic
#*# y_count = 7
#*# mesh_y_pps = 2
#*# min_y = 20.0
#*# x_count = 7
#*# max_y = 194.96
#*# mesh_x_pps = 2
#*# max_x = 230.98
#*#
#*# [bed_mesh zero]
#*# version = 1
#*# points =
#*# 	0.0, 0.0, 0.0, 0.0, 0.0
#*# 	0.0, 0.0, 0.0, 0.0, 0.0
#*# 	0.0, 0.0, 0.0, 0.0, 0.0
#*# 	0.0, 0.0, 0.0, 0.0, 0.0
#*# 	0.0, 0.0, 0.0, 0.0, 0.0
#*# tension = 0.2
#*# min_x = 25.0
#*# algo = lagrange
#*# y_count = 5
#*# mesh_y_pps = 2
#*# min_y = 34.0
#*# x_count = 5
#*# max_y = 201.0
#*# mesh_x_pps = 2
#*# max_x = 201.0
