[gcode_macro START_TIMELAPSE]
gcode:
  RESPOND PREFIX=timelapse MSG=start

[gcode_macro END_TIMELAPSE]
gcode:
  RESPOND PREFIX=timelapse MSG=stop
  RESPOND PREFIX=timelapse MSG=create

[gcode_macro PAUSE_TIMELAPSE]
gcode:
  RESPOND PREFIX=timelapse MSG=pause

[gcode_macro RESUME_TIMELAPSE]
gcode:
  RESPOND PREFIX=timelapse MSG=resume

[gcode_macro TIMELAPSE_PHOTO]
gcode:
  RESPOND PREFIX=timelapse MSG=photo

[gcode_macro CAPTURE_TIMELAPSE]
gcode:
  SAVE_GCODE_STATE NAME=TIMELAPSE_state
  {% set max_y = printer.toolhead.axis_maximum.y|float %}
  {% set max_z = printer.toolhead.axis_maximum.z|float %}
  {% set act_x = printer.toolhead.position.x|float %}
  {% set act_y = printer.toolhead.position.y|float %}
  {% set act_z = printer.toolhead.position.z|float %}
  {% set park_x = params.PARK_X|default(0)|float %}
  {% set park_y = params.PARK_Y|default(max_y)|float %}
  {% set retract = params.RETRACT|default(1)|float %}
  {% set delay = params.DELAY|default(500)|float %}
  G1 E-{retract} F2400
  {% if (act_z + 20) < max_z %}
    {% set new_z = act_z + 20 %}
  {% else %}
    {% set new_z = max_z %}
  {% endif %}
  G1 X{park_x} Y{park_y} Z{new_z} F24000
  M400
  G4 P100
  RESPOND PREFIX=timelapse MSG=photo
  G4 P{delay}
  G1 X{act_x} Y{act_y} Z{act_z} F24000
  G1 E{retract} F2400
  RESTORE_GCODE_STATE NAME=TIMELAPSE_state MOVE_SPEED=400

[gcode_macro SET_TIMELAPSE_PARAMS]
gcode:
  RESPOND PREFIX=set_timelapse_params MSG="{rawparams|lower}"

[gcode_macro SET_TIMELAPSE_NOTIFY_PARAMS]
gcode:
  RESPOND PREFIX=set_notify_params MSG="{rawparams|lower}"