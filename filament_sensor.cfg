[filament_switch_sensor filament_runout]
switch_pin: ^AXE_X_MIN
pause_on_runout: False
runout_gcode:
  {% set is_homed = "xyz" not in printer.toolhead.homed_axes %}
  {% set is_printing = printer.idle_timeout.state == "Printing" %}
  {% set is_paused = printer.pause_resume.is_paused == False %}
  {% if is_homed and is_printing and not is_paused %}
  RESPOND PREFIX=tgalarm MSG="Filament runout"
  PAUSE
  {% else %}
  RESPOND PREFIX=tgnotify MSG="Filament removed"
  {% endif %}
insert_gcode:
  RESPOND PREFIX=tgnotify MSG="Filament inserted"

[gcode_macro FILAMENT_CHANGE]
gcode:
  RESPOND PREFIX=tgalarm MSG="Filament change. Print paused!"
  PAUSE

[gcode_macro FILAMENT_UNLOAD]
gcode:
  G1 E-100 F250

[gcode_macro FILAMENT_LOAD]
gcode:
  G91
  G1 E70 F250
  G1 E30 F120
  G4 P3000
  {% set E = printer["gcode_macro PAUSE"].extrude|float %}
  G1 E-{E} F2100

[gcode_macro FILAMENT_LOAD_RESUME]
gcode:
  FILAMENT_LOAD
  RESUME

[gcode_macro FILAMENT_LOAD_RESUME_AFTER]
gcode:
  FILAMENT_LOAD
  RESUME