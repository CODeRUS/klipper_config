[extruder_stepper pusher]
extruder: extruder
step_pin: AXE_E2_STEP
dir_pin: !AXE_E2_DIR
enable_pin: !AXE_E2_EN
microsteps: 16
rotation_distance: 23.43 # bmg mini

[extruder_stepper pusher2]
extruder:
step_pin: AXE_E1_STEP
dir_pin: AXE_E1_DIR
enable_pin: !AXE_E1_EN
microsteps: 16
rotation_distance: 22.97

[filament_switch_sensor filament_runout]
switch_pin: ^AXE_X_MIN
pause_on_runout: False
runout_gcode:
  {% set is_homed = "xyz" in printer.toolhead.homed_axes %}
  {% set is_printing = printer.idle_timeout.state|lower == "printing" %}
  {% set is_paused = printer.pause_resume.is_paused == True %}
  {% if is_homed and is_printing and not is_paused %}
  RESPOND PREFIX=tgalarm MSG="Filament runout"
  PAUSE
  {% else %}
  RESPOND PREFIX=tgnotify MSG="Filament removed"
  {% endif %}
insert_gcode:
  RESPOND PREFIX=tgnotify MSG="Filament inserted"

[gcode_macro DEBUG_STATE]
gcode:
  {% set is_printing = printer.idle_timeout.state|lower == "printing" %}
  {% set is_paused = printer.pause_resume.is_paused == True %}
  {% set is_homed = "xyz" in printer.toolhead.homed_axes %}
  {% set is_runout_ready = is_homed and is_printing and not is_paused %}
  RESPOND MSG="is_printing: {is_printing}"
  RESPOND MSG="is_paused: {is_paused}"
  RESPOND MSG="is_homed: {is_homed}"
  RESPOND MSG="is_runout_ready: {is_runout_ready}"

[gcode_macro FILAMENT_CHANGE]
gcode:
  RESPOND PREFIX=tgalarm MSG="Filament change. Print paused!"
  PAUSE

[gcode_macro FILAMENT_UNLOAD]
gcode:
  G1 E-100 F250

[gcode_macro FILAMENT_LOAD]
gcode:
  G91
  G1 E70 F250
  G1 E30 F120
  G4 P1000
  {% set E = printer["gcode_macro PAUSE"].extrude|float %}
  G1 E-{E} F2100

[gcode_macro FILAMENT_LOAD_RESUME]
gcode:
  FILAMENT_LOAD
  RESUME

[gcode_macro FILAMENT_LOAD_RESUME_AFTER]
gcode:
  FILAMENT_LOAD
  RESUME

[gcode_macro PUSHER_ACTIVATE]
variable_active_pusher: "pusher"
gcode:
  {% set last_pusher = printer["gcode_macro PUSHER_ACTIVATE"].active_pusher %}
  SYNC_EXTRUDER_MOTION EXTRUDER={last_pusher} MOTION_QUEUE= 

  {% set active_pusher = params.PUSHER|default("pusher") %}
  RESPOND MSG="Active pusher: {active_pusher}"

  SET_GCODE_VARIABLE MACRO=PUSHER_ACTIVATE VARIABLE="active_pusher" VALUE="\"{active_pusher}\""
  SYNC_EXTRUDER_MOTION EXTRUDER="{active_pusher}" MOTION_QUEUE=extruder 

[gcode_macro PUSHER_ACTIVATE_1]
gcode:
  PUSHER_ACTIVATE PUSHER="pusher"

[gcode_macro PUSHER_ACTIVATE_2]
gcode:
  PUSHER_ACTIVATE PUSHER="pusher2"

[gcode_macro GET_ACTIVE_PUSHER]
gcode:
  {% set active_pusher = printer["gcode_macro PUSHER_ACTIVATE"].active_pusher %}
  RESPOND MSG="Active pusher: {active_pusher}"

[gcode_macro FILAMENT_PUSHER_LOAD]
gcode:
  SYNC_EXTRUDER_MOTION EXTRUDER=extruder MOTION_QUEUE=
  {% set active_pusher = printer["gcode_macro PUSHER_ACTIVATE"].active_pusher %}
  {% if active_pusher == "pusher" %}
  G1 E780 F3000
  {% else %}
  G1 E630 F3000
  {% endif %}
  SYNC_EXTRUDER_MOTION EXTRUDER=extruder MOTION_QUEUE=extruder
  G1 E20 F120
  FILAMENT_LOAD

[gcode_macro FILAMENT_PUSHER_UNLOAD]
gcode:
  FILAMENT_UNLOAD
  SYNC_EXTRUDER_MOTION EXTRUDER=extruder MOTION_QUEUE=
  {% set active_pusher = printer["gcode_macro PUSHER_ACTIVATE"].active_pusher %}
  {% if active_pusher == "pusher" %}
  G1 E-800 F3000
  {% else %}
  G1 E-650 F3000
  {% endif %}
  SYNC_EXTRUDER_MOTION EXTRUDER=extruder MOTION_QUEUE=extruder

